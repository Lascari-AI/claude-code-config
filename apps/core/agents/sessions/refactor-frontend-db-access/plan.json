{
  "$schema": "Plan schema for session checkpoint-based planning (v2)",

  "session_id": "refactor-frontend-db-access",
  "spec_reference": "./spec.md",
  "created_at": "2026-02-13T00:00:00Z",
  "updated_at": "2026-02-13T00:00:00Z",
  "status": "complete",

  "checkpoints": [
    {
      "id": 1,
      "title": "End-to-End Project List via Drizzle",
      "goal": "Establish Drizzle ORM in Next.js and migrate project listing from backend to frontend with direct database access. One complete flow from DB to UI.",
      "prerequisites": [],
      "status": "completed",
      "summary": "Set up Drizzle infrastructure, pull schema from existing PostgreSQL, create first direct DB query (list projects). Validates the entire Drizzle pipeline works.",
      "task_groups": [
        {
          "id": "1.1",
          "title": "Install & Configure Drizzle",
          "objective": "Set up Drizzle ORM dependencies and configuration in the frontend",
          "status": "pending",
          "tasks": [
            {
              "id": "1.1.1",
              "title": "Install Drizzle dependencies",
              "file_path": "frontend/package.json",
              "description": "Add Drizzle ORM packages to the frontend. drizzle-orm and postgres are runtime dependencies for database access. drizzle-kit is a dev dependency for schema generation.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/package.json", "purpose": "Check existing dependencies to avoid conflicts" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "1.1.1.1", "command": "ADD drizzle-orm to dependencies", "file": "frontend/package.json", "status": "pending" },
                { "id": "1.1.1.2", "command": "ADD postgres to dependencies", "file": "frontend/package.json", "status": "pending" },
                { "id": "1.1.1.3", "command": "ADD drizzle-kit to devDependencies", "file": "frontend/package.json", "status": "pending" }
              ]
            },
            {
              "id": "1.1.2",
              "title": "Create Drizzle configuration file",
              "file_path": "frontend/drizzle.config.ts",
              "description": "Configure drizzle-kit for schema introspection. Points to DATABASE_URL env var and specifies output paths for generated schema files.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "session_db/database.py", "lines": "1-30", "purpose": "Understand existing database connection pattern" }
                ],
                "related_files": ["frontend/.env.local"]
              },
              "depends_on": ["1.1.1"],
              "actions": [
                { "id": "1.1.2.1", "command": "CREATE frontend/drizzle.config.ts with postgres dialect, DATABASE_URL from process.env, schema output ./src/db/schema.ts, migrations output ./drizzle", "file": "frontend/drizzle.config.ts", "status": "pending" }
              ]
            },
            {
              "id": "1.1.3",
              "title": "Add database environment variables",
              "file_path": "frontend/.env.local",
              "description": "Add DATABASE_URL environment variable pointing to PostgreSQL. Mirror connection string format from backend configuration.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "session_db/.env", "purpose": "Get existing database connection string format" }
                ],
                "related_files": ["frontend/.env.example"]
              },
              "depends_on": [],
              "actions": [
                { "id": "1.1.3.1", "command": "CREATE frontend/.env.local with DATABASE_URL=postgresql://... (mirror backend format)", "file": "frontend/.env.local", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "1.2",
          "title": "Generate Schema from Database",
          "objective": "Pull existing schema from PostgreSQL and generate TypeScript types using drizzle-kit",
          "status": "pending",
          "tasks": [
            {
              "id": "1.2.1",
              "title": "Run drizzle-kit pull",
              "file_path": "frontend/src/db/schema.ts",
              "description": "Execute drizzle-kit pull command to introspect the existing PostgreSQL database and generate TypeScript schema. This reads the live database structure and outputs Drizzle table definitions.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "session_db/models.py", "purpose": "Reference SQLModel definitions to verify generated schema matches" },
                  { "file": "frontend/drizzle.config.ts", "purpose": "Confirm drizzle-kit configuration before running" }
                ],
                "related_files": ["frontend/.env.local"]
              },
              "depends_on": ["1.1.2", "1.1.3"],
              "actions": [
                { "id": "1.2.1.1", "command": "RUN npx drizzle-kit pull in frontend directory", "file": "frontend/src/db/schema.ts", "status": "pending" }
              ]
            },
            {
              "id": "1.2.2",
              "title": "Review and organize generated schema",
              "file_path": "frontend/src/db/schema.ts",
              "description": "Verify generated Drizzle schema matches SQLModel definitions. Add exports for table types. Ensure naming conventions are correct (projects, sessions, agents, agent_logs tables).",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "session_db/models.py", "purpose": "Compare generated types against Python models" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Review generated schema for correctness" }
                ],
                "related_files": []
              },
              "depends_on": ["1.2.1"],
              "actions": [
                { "id": "1.2.2.1", "command": "VERIFY tables: projects, sessions, agents, agent_logs exist in schema", "file": "frontend/src/db/schema.ts", "status": "pending" },
                { "id": "1.2.2.2", "command": "ADD type exports for table inference (e.g., export type Project = typeof projects.$inferSelect)", "file": "frontend/src/db/schema.ts", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "1.3",
          "title": "Migrate getProjects() to Drizzle",
          "objective": "Replace backend API call with direct Drizzle database query for project listing",
          "status": "pending",
          "tasks": [
            {
              "id": "1.3.1",
              "title": "Create Drizzle client initialization",
              "file_path": "frontend/src/db/index.ts",
              "description": "Initialize Drizzle client with PostgreSQL connection. Export db instance for use throughout the application. Connection uses DATABASE_URL from environment.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import schema for typed queries" },
                  { "file": "session_db/database.py", "lines": "1-50", "purpose": "Reference Python database initialization pattern" }
                ],
                "related_files": ["frontend/.env.local"]
              },
              "depends_on": ["1.2.2"],
              "actions": [
                { "id": "1.3.1.1", "command": "CREATE frontend/src/db/index.ts with drizzle client initialization using postgres driver and schema import", "file": "frontend/src/db/index.ts", "status": "pending" }
              ]
            },
            {
              "id": "1.3.2",
              "title": "Implement getProjects() with Drizzle",
              "file_path": "frontend/src/lib/projects-api.ts",
              "description": "Replace fetchApi call to backend with direct Drizzle query. Query projects table with same filtering (status), limit, and offset parameters. Return ProjectSummary[] matching existing interface.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/projects-api.ts", "purpose": "Understand existing getProjects signature and return type" },
                  { "file": "frontend/src/db/index.ts", "purpose": "Import db client" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import projects table for query" },
                  { "file": "backend/routers/projects.py", "lines": "173-188", "purpose": "Reference backend query logic to replicate" }
                ],
                "related_files": ["frontend/src/types/project.ts"]
              },
              "depends_on": ["1.3.1"],
              "actions": [
                { "id": "1.3.2.1", "command": "UPDATE getProjects() FUNCTION: REPLACE fetchApi call with Drizzle select from projects table", "file": "frontend/src/lib/projects-api.ts", "status": "pending" },
                { "id": "1.3.2.2", "command": "ADD status filter using where clause if status param provided", "file": "frontend/src/lib/projects-api.ts", "status": "pending" },
                { "id": "1.3.2.3", "command": "ADD limit and offset using Drizzle limit() and offset() methods", "file": "frontend/src/lib/projects-api.ts", "status": "pending" },
                { "id": "1.3.2.4", "command": "ADD orderBy updated_at desc to match backend behavior", "file": "frontend/src/lib/projects-api.ts", "status": "pending" }
              ]
            },
            {
              "id": "1.3.3",
              "title": "Verify end-to-end flow",
              "file_path": "frontend/src/lib/projects-api.ts",
              "description": "Run TypeScript build to verify no type errors. Start frontend and manually verify project list loads correctly from database without backend involvement.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/projects-api.ts", "purpose": "Review completed implementation" }
                ],
                "related_files": []
              },
              "depends_on": ["1.3.2"],
              "actions": [
                { "id": "1.3.3.1", "command": "RUN npm run build in frontend to verify TypeScript compilation", "file": "frontend/package.json", "status": "pending" },
                { "id": "1.3.3.2", "command": "TEST manually: start frontend, navigate to project list, verify data loads", "file": "frontend/src/lib/projects-api.ts", "status": "pending" }
              ]
            }
          ]
        }
      ],
      "file_context": {
        "beginning": {
          "files": [
            { "path": "frontend/src/lib/api.ts", "status": "exists", "description": "Current fetch wrapper to backend" },
            { "path": "frontend/src/lib/projects-api.ts", "status": "exists", "description": "Projects API calling backend" },
            { "path": "backend/routers/projects.py", "status": "exists", "description": "Backend project routes" }
          ]
        },
        "ending": {
          "files": [
            { "path": "frontend/src/db/index.ts", "status": "new", "description": "Drizzle client initialization" },
            { "path": "frontend/src/db/schema.ts", "status": "new", "description": "Drizzle schema (pulled from DB)" },
            { "path": "frontend/src/lib/projects-api.ts", "status": "modified", "description": "getProjects() now uses Drizzle directly" }
          ]
        }
      },
      "testing_strategy": {
        "approach": "Manual verification + TypeScript type checking",
        "verification_steps": [
          "npm run build (frontend) - verify no type errors",
          "Start frontend, navigate to project list, verify projects load from database"
        ]
      }
    },
    {
      "id": 2,
      "title": "Complete Project CRUD Migration",
      "goal": "Migrate remaining project operations (get, create, update, delete, onboard) to frontend Drizzle access.",
      "prerequisites": [1],
      "status": "completed",
      "summary": "With Drizzle working for list, extend to full CRUD. Onboarding already partially uses local routes; complete the migration.",
      "task_groups": [
        {
          "id": "2.1",
          "title": "Project Read Operations",
          "objective": "Migrate getProject() and getProjectBySlug() to direct Drizzle queries",
          "status": "pending",
          "tasks": [
            {
              "id": "2.1.1",
              "title": "Migrate getProject() to Drizzle",
              "file_path": "frontend/src/lib/projects-api.ts",
              "description": "Replace backend API call with Drizzle query. Select project by UUID, return full Project type.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/projects-api.ts", "purpose": "Understand existing getProject signature" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import projects table" },
                  { "file": "backend/routers/projects.py", "lines": "191-207", "purpose": "Reference backend query logic" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "2.1.1.1", "command": "UPDATE getProject(id) FUNCTION: REPLACE fetchApi with Drizzle select where id equals param", "file": "frontend/src/lib/projects-api.ts", "status": "pending" }
              ]
            },
            {
              "id": "2.1.2",
              "title": "Migrate getProjectBySlug() to Drizzle",
              "file_path": "frontend/src/lib/projects-api.ts",
              "description": "Replace backend API call with Drizzle query. Select project by slug, return full Project type.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/projects-api.ts", "purpose": "Understand existing getProjectBySlug signature" },
                  { "file": "backend/routers/projects.py", "lines": "210-226", "purpose": "Reference backend query logic" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "2.1.2.1", "command": "UPDATE getProjectBySlug(slug) FUNCTION: REPLACE fetchApi with Drizzle select where slug equals param", "file": "frontend/src/lib/projects-api.ts", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "2.2",
          "title": "Project Write Operations via API Routes",
          "objective": "Create Next.js API routes for project mutations (create, update, delete) since mutations need server-side execution",
          "status": "pending",
          "tasks": [
            {
              "id": "2.2.1",
              "title": "Create projects API route handler",
              "file_path": "frontend/src/app/api/projects/route.ts",
              "description": "Create Next.js API route for project mutations. POST for create, route handler structure.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/app/api/browse/route.ts", "purpose": "Reference existing API route pattern" },
                  { "file": "backend/routers/projects.py", "lines": "229-252", "purpose": "Reference create project logic" }
                ],
                "related_files": ["frontend/src/db/index.ts", "frontend/src/db/schema.ts"]
              },
              "depends_on": [],
              "actions": [
                { "id": "2.2.1.1", "command": "CREATE frontend/src/app/api/projects/route.ts with POST handler for createProject", "file": "frontend/src/app/api/projects/route.ts", "status": "pending" },
                { "id": "2.2.1.2", "command": "ADD slug uniqueness check before insert", "file": "frontend/src/app/api/projects/route.ts", "status": "pending" },
                { "id": "2.2.1.3", "command": "ADD Drizzle insert to projects table, return created project", "file": "frontend/src/app/api/projects/route.ts", "status": "pending" }
              ]
            },
            {
              "id": "2.2.2",
              "title": "Create project by ID API route",
              "file_path": "frontend/src/app/api/projects/[id]/route.ts",
              "description": "Create dynamic route for project operations by ID. PATCH for update, DELETE for delete.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/routers/projects.py", "lines": "255-304", "purpose": "Reference update and delete logic" }
                ],
                "related_files": []
              },
              "depends_on": ["2.2.1"],
              "actions": [
                { "id": "2.2.2.1", "command": "CREATE frontend/src/app/api/projects/[id]/route.ts with PATCH handler for updateProject", "file": "frontend/src/app/api/projects/[id]/route.ts", "status": "pending" },
                { "id": "2.2.2.2", "command": "ADD DELETE handler for deleteProject", "file": "frontend/src/app/api/projects/[id]/route.ts", "status": "pending" },
                { "id": "2.2.2.3", "command": "ADD 404 handling if project not found", "file": "frontend/src/app/api/projects/[id]/route.ts", "status": "pending" }
              ]
            },
            {
              "id": "2.2.3",
              "title": "Update projects-api.ts to use local routes",
              "file_path": "frontend/src/lib/projects-api.ts",
              "description": "Update createProject, updateProject, deleteProject functions to call local Next.js API routes instead of backend.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/projects-api.ts", "purpose": "Understand existing function signatures" }
                ],
                "related_files": []
              },
              "depends_on": ["2.2.1", "2.2.2"],
              "actions": [
                { "id": "2.2.3.1", "command": "UPDATE createProject() to fetch /api/projects with POST", "file": "frontend/src/lib/projects-api.ts", "status": "pending" },
                { "id": "2.2.3.2", "command": "UPDATE updateProject() to fetch /api/projects/[id] with PATCH", "file": "frontend/src/lib/projects-api.ts", "status": "pending" },
                { "id": "2.2.3.3", "command": "UPDATE deleteProject() to fetch /api/projects/[id] with DELETE", "file": "frontend/src/lib/projects-api.ts", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "2.3",
          "title": "Onboarding Migration",
          "objective": "Complete migration of onboardProject() to use Drizzle for database writes",
          "status": "pending",
          "tasks": [
            {
              "id": "2.3.1",
              "title": "Create onboard API route",
              "file_path": "frontend/src/app/api/projects/onboard/route.ts",
              "description": "Create onboarding endpoint that validates path, checks for .claude dir, and creates project with appropriate status.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/routers/projects.py", "lines": "343-415", "purpose": "Reference full onboarding logic" },
                  { "file": "frontend/src/app/api/validate-path/route.ts", "purpose": "Reference existing path validation pattern" }
                ],
                "related_files": ["frontend/src/lib/projects-api.ts"]
              },
              "depends_on": ["2.2.1"],
              "actions": [
                { "id": "2.3.1.1", "command": "CREATE frontend/src/app/api/projects/onboard/route.ts with POST handler", "file": "frontend/src/app/api/projects/onboard/route.ts", "status": "pending" },
                { "id": "2.3.1.2", "command": "ADD path validation logic (expanduser, isdir check)", "file": "frontend/src/app/api/projects/onboard/route.ts", "status": "pending" },
                { "id": "2.3.1.3", "command": "ADD .claude directory detection", "file": "frontend/src/app/api/projects/onboard/route.ts", "status": "pending" },
                { "id": "2.3.1.4", "command": "ADD slug generation from project name", "file": "frontend/src/app/api/projects/onboard/route.ts", "status": "pending" },
                { "id": "2.3.1.5", "command": "ADD Drizzle insert with onboarding_status JSON", "file": "frontend/src/app/api/projects/onboard/route.ts", "status": "pending" }
              ]
            },
            {
              "id": "2.3.2",
              "title": "Update onboardProject() function",
              "file_path": "frontend/src/lib/projects-api.ts",
              "description": "Update onboardProject() to call local /api/projects/onboard route instead of backend.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/projects-api.ts", "purpose": "Understand existing onboardProject signature" }
                ],
                "related_files": []
              },
              "depends_on": ["2.3.1"],
              "actions": [
                { "id": "2.3.2.1", "command": "UPDATE onboardProject() to fetch /api/projects/onboard with POST", "file": "frontend/src/lib/projects-api.ts", "status": "pending" }
              ]
            }
          ]
        }
      ],
      "file_context": {
        "beginning": {
          "files": [
            { "path": "frontend/src/db/index.ts", "status": "exists", "description": "Drizzle client from CP1" },
            { "path": "frontend/src/lib/projects-api.ts", "status": "exists", "description": "Mixed: list=Drizzle, rest=backend" }
          ]
        },
        "ending": {
          "files": [
            { "path": "frontend/src/lib/projects-api.ts", "status": "modified", "description": "All project ops via Drizzle" },
            { "path": "frontend/src/app/api/projects/route.ts", "status": "new", "description": "Next.js API route for project mutations" }
          ]
        }
      },
      "testing_strategy": {
        "approach": "Manual CRUD testing",
        "verification_steps": [
          "Create new project via UI, verify in database",
          "Update project, verify changes persist",
          "Delete project, verify removed"
        ]
      }
    },
    {
      "id": 3,
      "title": "Session Listing via Drizzle",
      "goal": "Migrate session list and get operations to frontend Drizzle access.",
      "prerequisites": [1],
      "status": "completed",
      "summary": "Apply same pattern as projects. Sessions list/get moves to frontend DB access.",
      "task_groups": [
        {
          "id": "3.1",
          "title": "Session Read Operations",
          "objective": "Migrate getSessions(), getSession(), and getSessionBySlug() to direct Drizzle queries",
          "status": "pending",
          "tasks": [
            {
              "id": "3.1.1",
              "title": "Migrate getSessions() to Drizzle",
              "file_path": "frontend/src/lib/sessions-api.ts",
              "description": "Replace backend API call with Drizzle query. Support filters for status, sessionType, projectId. Apply limit/offset pagination.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/sessions-api.ts", "purpose": "Understand existing getSessions signature and SessionFilters type" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import sessions table" },
                  { "file": "backend/routers/sessions.py", "lines": "50-76", "purpose": "Reference backend query logic with filters" }
                ],
                "related_files": ["frontend/src/types/session.ts"]
              },
              "depends_on": [],
              "actions": [
                { "id": "3.1.1.1", "command": "UPDATE getSessions() FUNCTION: REPLACE fetchApi with Drizzle select from sessions table", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "3.1.1.2", "command": "ADD where clauses for status, session_type, project_id filters", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "3.1.1.3", "command": "ADD limit and offset using Drizzle methods", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "3.1.1.4", "command": "ADD orderBy updated_at desc", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" }
              ]
            },
            {
              "id": "3.1.2",
              "title": "Migrate getSession() to Drizzle",
              "file_path": "frontend/src/lib/sessions-api.ts",
              "description": "Replace backend API call with Drizzle query. Select session by UUID, return full Session type.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/sessions-api.ts", "purpose": "Understand existing getSession signature" },
                  { "file": "backend/routers/sessions.py", "lines": "79-95", "purpose": "Reference backend query logic" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "3.1.2.1", "command": "UPDATE getSession(id) FUNCTION: REPLACE fetchApi with Drizzle select where id equals param", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" }
              ]
            },
            {
              "id": "3.1.3",
              "title": "Migrate getSessionBySlug() to Drizzle",
              "file_path": "frontend/src/lib/sessions-api.ts",
              "description": "Replace backend API call with Drizzle query. Select session by session_slug, return full Session type.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/sessions-api.ts", "purpose": "Understand existing getSessionBySlug signature" },
                  { "file": "backend/routers/sessions.py", "lines": "98-114", "purpose": "Reference backend query logic" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "3.1.3.1", "command": "UPDATE getSessionBySlug(slug) FUNCTION: REPLACE fetchApi with Drizzle select where session_slug equals param", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "3.2",
          "title": "Project Sessions Query",
          "objective": "Migrate getProjectSessions() to Drizzle (sessions filtered by project_id)",
          "status": "pending",
          "tasks": [
            {
              "id": "3.2.1",
              "title": "Migrate getProjectSessions() to Drizzle",
              "file_path": "frontend/src/lib/sessions-api.ts",
              "description": "Replace backend API call with Drizzle query. Filter sessions by project_id with additional status/type filters. Used on project detail page.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/sessions-api.ts", "purpose": "Understand existing getProjectSessions signature" },
                  { "file": "backend/routers/projects.py", "lines": "307-340", "purpose": "Reference backend query logic for project sessions" }
                ],
                "related_files": []
              },
              "depends_on": ["3.1.1"],
              "actions": [
                { "id": "3.2.1.1", "command": "UPDATE getProjectSessions() FUNCTION: REPLACE fetchApi with Drizzle select where project_id equals param", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "3.2.1.2", "command": "ADD additional filters (status, session_type) matching existing interface", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" }
              ]
            }
          ]
        }
      ],
      "file_context": {
        "beginning": {
          "files": [
            { "path": "frontend/src/lib/sessions-api.ts", "status": "exists", "description": "Sessions API calling backend" },
            { "path": "backend/routers/sessions.py", "status": "exists", "description": "Backend session routes" }
          ]
        },
        "ending": {
          "files": [
            { "path": "frontend/src/lib/sessions-api.ts", "status": "modified", "description": "getSessions/getSession via Drizzle" }
          ]
        }
      },
      "testing_strategy": {
        "approach": "Manual verification",
        "verification_steps": [
          "Navigate to sessions list, verify loads correctly",
          "Click into session detail, verify session data loads"
        ]
      }
    },
    {
      "id": 4,
      "title": "Session Artifacts via Next.js API Routes",
      "goal": "Create Next.js API routes for reading session artifacts (spec.md, plan.json, state.json) from filesystem.",
      "prerequisites": [3],
      "status": "completed",
      "summary": "Artifacts live on filesystem. Create API routes similar to existing /api/browse pattern to serve them.",
      "task_groups": [
        {
          "id": "4.1",
          "title": "Artifact API Routes",
          "objective": "Create Next.js dynamic routes for serving spec.md, plan.json, and state.json from filesystem",
          "status": "pending",
          "tasks": [
            {
              "id": "4.1.1",
              "title": "Create spec.md API route",
              "file_path": "frontend/src/app/api/sessions/[slug]/spec/route.ts",
              "description": "Create GET endpoint that looks up session by slug (via Drizzle), reads spec.md from session_dir, returns markdown content.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/routers/sessions.py", "lines": "122-177", "purpose": "Reference backend _get_session_dir and spec reading logic" },
                  { "file": "frontend/src/app/api/browse/route.ts", "purpose": "Reference existing filesystem access pattern in Next.js" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import sessions table for slug lookup" }
                ],
                "related_files": ["frontend/src/db/index.ts"]
              },
              "depends_on": [],
              "actions": [
                { "id": "4.1.1.1", "command": "CREATE frontend/src/app/api/sessions/[slug]/spec/route.ts with GET handler", "file": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "status": "pending" },
                { "id": "4.1.1.2", "command": "ADD Drizzle query to get session by slug, extract session_dir or construct from working_dir", "file": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "status": "pending" },
                { "id": "4.1.1.3", "command": "ADD fs.readFile to read spec.md, return JSON { content, exists }", "file": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "status": "pending" },
                { "id": "4.1.1.4", "command": "ADD 404 handling if session or file not found", "file": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "status": "pending" }
              ]
            },
            {
              "id": "4.1.2",
              "title": "Create plan.json API route",
              "file_path": "frontend/src/app/api/sessions/[slug]/plan/route.ts",
              "description": "Create GET endpoint that reads plan.json from session_dir, parses and returns JSON.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/routers/sessions.py", "lines": "180-224", "purpose": "Reference backend plan reading logic" },
                  { "file": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "purpose": "Mirror pattern from spec route" }
                ],
                "related_files": []
              },
              "depends_on": ["4.1.1"],
              "actions": [
                { "id": "4.1.2.1", "command": "CREATE frontend/src/app/api/sessions/[slug]/plan/route.ts MIRROR spec route pattern", "file": "frontend/src/app/api/sessions/[slug]/plan/route.ts", "status": "pending" },
                { "id": "4.1.2.2", "command": "ADD JSON.parse for plan.json content, return parsed object", "file": "frontend/src/app/api/sessions/[slug]/plan/route.ts", "status": "pending" }
              ]
            },
            {
              "id": "4.1.3",
              "title": "Create state.json API route",
              "file_path": "frontend/src/app/api/sessions/[slug]/state/route.ts",
              "description": "Create GET endpoint that reads state.json from session_dir, parses and returns JSON.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/routers/sessions.py", "lines": "227-271", "purpose": "Reference backend state reading logic" },
                  { "file": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "purpose": "Mirror pattern from spec route" }
                ],
                "related_files": []
              },
              "depends_on": ["4.1.1"],
              "actions": [
                { "id": "4.1.3.1", "command": "CREATE frontend/src/app/api/sessions/[slug]/state/route.ts MIRROR spec route pattern", "file": "frontend/src/app/api/sessions/[slug]/state/route.ts", "status": "pending" },
                { "id": "4.1.3.2", "command": "ADD JSON.parse for state.json content, return parsed object", "file": "frontend/src/app/api/sessions/[slug]/state/route.ts", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "4.2",
          "title": "Update Sessions API Client",
          "objective": "Update getSessionSpec(), getSessionPlan(), getSessionState() to use local Next.js routes instead of backend",
          "status": "pending",
          "tasks": [
            {
              "id": "4.2.1",
              "title": "Update artifact fetch functions",
              "file_path": "frontend/src/lib/sessions-api.ts",
              "description": "Update getSessionSpec, getSessionPlan, getSessionState to fetch from /api/sessions/[slug]/... instead of backend.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/sessions-api.ts", "purpose": "Understand existing artifact fetch signatures" }
                ],
                "related_files": []
              },
              "depends_on": ["4.1.1", "4.1.2", "4.1.3"],
              "actions": [
                { "id": "4.2.1.1", "command": "UPDATE getSessionSpec() to fetch /api/sessions/${slug}/spec instead of backend", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "4.2.1.2", "command": "UPDATE getSessionPlan() to fetch /api/sessions/${slug}/plan instead of backend", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "4.2.1.3", "command": "UPDATE getSessionState() to fetch /api/sessions/${slug}/state instead of backend", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" }
              ]
            }
          ]
        }
      ],
      "file_context": {
        "beginning": {
          "files": [
            { "path": "backend/routers/sessions.py", "status": "exists", "description": "Backend artifact endpoints" },
            { "path": "frontend/src/app/api/browse/route.ts", "status": "exists", "description": "Existing fs access pattern" }
          ]
        },
        "ending": {
          "files": [
            { "path": "frontend/src/app/api/sessions/[slug]/spec/route.ts", "status": "new", "description": "Serve spec.md" },
            { "path": "frontend/src/app/api/sessions/[slug]/plan/route.ts", "status": "new", "description": "Serve plan.json" },
            { "path": "frontend/src/app/api/sessions/[slug]/state/route.ts", "status": "new", "description": "Serve state.json" },
            { "path": "frontend/src/lib/sessions-api.ts", "status": "modified", "description": "Artifact fetches use local routes" }
          ]
        }
      },
      "testing_strategy": {
        "approach": "API testing + UI verification",
        "verification_steps": [
          "curl /api/sessions/{slug}/spec - verify returns markdown",
          "View session in UI, verify spec/plan/state render correctly"
        ]
      }
    },
    {
      "id": 5,
      "title": "Agent Listing via Drizzle",
      "goal": "Migrate agent list and log endpoints to frontend Drizzle access.",
      "prerequisites": [3],
      "status": "pending",
      "summary": "Final data migration: agents and logs move to frontend DB access.",
      "task_groups": [
        {
          "id": "5.1",
          "title": "Agent Read Operations",
          "objective": "Migrate agent listing and single agent get to Drizzle",
          "status": "pending",
          "tasks": [
            {
              "id": "5.1.1",
              "title": "Migrate getSessionAgents() to Drizzle",
              "file_path": "frontend/src/lib/sessions-api.ts",
              "description": "Replace backend API call with Drizzle query. Select agents where session_id equals param, return AgentSummary[].",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/sessions-api.ts", "purpose": "Understand existing getSessionAgents signature" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import agents table" },
                  { "file": "backend/routers/agents.py", "lines": "30-54", "purpose": "Reference backend query logic for session agents" }
                ],
                "related_files": ["frontend/src/types/agent.ts"]
              },
              "depends_on": [],
              "actions": [
                { "id": "5.1.1.1", "command": "UPDATE getSessionAgents(sessionId) FUNCTION: REPLACE fetchApi with Drizzle select from agents where session_id equals param", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "5.1.1.2", "command": "ADD orderBy created_at to maintain chronological order", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" }
              ]
            },
            {
              "id": "5.1.2",
              "title": "Migrate getAgent() to Drizzle",
              "file_path": "frontend/src/lib/agents-api.ts",
              "description": "Replace backend API call with Drizzle query. Select agent by UUID, return full Agent type.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/agents-api.ts", "purpose": "Understand existing getAgent signature" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import agents table" },
                  { "file": "backend/routers/agents.py", "lines": "57-80", "purpose": "Reference backend query logic" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "5.1.2.1", "command": "UPDATE getAgent(agentId) FUNCTION: REPLACE fetchApi with Drizzle select where id equals param", "file": "frontend/src/lib/agents-api.ts", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "5.2",
          "title": "Agent Logs",
          "objective": "Migrate agent log listing to Drizzle queries",
          "status": "pending",
          "tasks": [
            {
              "id": "5.2.1",
              "title": "Migrate getAgentLogs() to Drizzle",
              "file_path": "frontend/src/lib/agents-api.ts",
              "description": "Replace backend API call with Drizzle query. Select logs where agent_id equals param, with category/type filters, pagination.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/agents-api.ts", "purpose": "Understand existing getAgentLogs signature and AgentLogFilters" },
                  { "file": "frontend/src/db/schema.ts", "purpose": "Import agent_logs table" },
                  { "file": "backend/routers/agents.py", "lines": "83-142", "purpose": "Reference backend query logic with filters" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "5.2.1.1", "command": "UPDATE getAgentLogs(agentId, filters) FUNCTION: REPLACE fetchApi with Drizzle select from agent_logs where agent_id equals param", "file": "frontend/src/lib/agents-api.ts", "status": "pending" },
                { "id": "5.2.1.2", "command": "ADD where clauses for event_category, event_type filters if provided", "file": "frontend/src/lib/agents-api.ts", "status": "pending" },
                { "id": "5.2.1.3", "command": "ADD limit, offset, orderBy timestamp asc for chronological order", "file": "frontend/src/lib/agents-api.ts", "status": "pending" }
              ]
            },
            {
              "id": "5.2.2",
              "title": "Migrate getAgentLogDetail() to Drizzle",
              "file_path": "frontend/src/lib/agents-api.ts",
              "description": "Replace backend API call with Drizzle query. Select single log by ID with full payload.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "frontend/src/lib/agents-api.ts", "purpose": "Understand existing getAgentLogDetail signature" },
                  { "file": "backend/routers/agents.py", "lines": "145-179", "purpose": "Reference backend query logic" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "5.2.2.1", "command": "UPDATE getAgentLogDetail(agentId, logId) FUNCTION: REPLACE fetchApi with Drizzle select where id equals logId AND agent_id equals agentId", "file": "frontend/src/lib/agents-api.ts", "status": "pending" }
              ]
            }
          ]
        }
      ],
      "file_context": {
        "beginning": {
          "files": [
            { "path": "frontend/src/lib/agents-api.ts", "status": "exists", "description": "Agents API calling backend" },
            { "path": "backend/routers/agents.py", "status": "exists", "description": "Backend agent routes" }
          ]
        },
        "ending": {
          "files": [
            { "path": "frontend/src/lib/agents-api.ts", "status": "modified", "description": "All agent queries via Drizzle" }
          ]
        }
      },
      "testing_strategy": {
        "approach": "Manual verification",
        "verification_steps": [
          "View session with agents, verify agent list loads",
          "View agent logs, verify logs display correctly"
        ]
      }
    },
    {
      "id": 6,
      "title": "Strip Backend to Minimal",
      "goal": "Remove migrated routes from backend, leaving only health check and future agent execution endpoints.",
      "prerequisites": [2, 4, 5],
      "status": "pending",
      "summary": "Clean up: remove projects, sessions, agents routers from backend. Document architecture change.",
      "task_groups": [
        {
          "id": "6.1",
          "title": "Remove Backend Routes",
          "objective": "Delete projects, sessions, agents routers and update main.py to remove imports",
          "status": "pending",
          "tasks": [
            {
              "id": "6.1.1",
              "title": "Update main.py to remove router registrations",
              "file_path": "backend/main.py",
              "description": "Remove include_router calls for projects, sessions, and agents. Remove corresponding imports. Keep only health check endpoint.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/main.py", "purpose": "Understand current router registrations and imports to remove" }
                ],
                "related_files": []
              },
              "depends_on": [],
              "actions": [
                { "id": "6.1.1.1", "command": "REMOVE import statements for agents, projects, sessions routers", "file": "backend/main.py", "status": "pending" },
                { "id": "6.1.1.2", "command": "REMOVE app.include_router(agents.router)", "file": "backend/main.py", "status": "pending" },
                { "id": "6.1.1.3", "command": "REMOVE app.include_router(projects.router)", "file": "backend/main.py", "status": "pending" },
                { "id": "6.1.1.4", "command": "REMOVE app.include_router(sessions.router)", "file": "backend/main.py", "status": "pending" }
              ]
            },
            {
              "id": "6.1.2",
              "title": "Delete backend router files",
              "file_path": "backend/routers/",
              "description": "Delete the now-unused router files. Keep __init__.py empty or remove if no other routers exist.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/routers/__init__.py", "purpose": "Check what else exists in routers package" }
                ],
                "related_files": []
              },
              "depends_on": ["6.1.1"],
              "actions": [
                { "id": "6.1.2.1", "command": "DELETE backend/routers/projects.py", "file": "backend/routers/projects.py", "status": "pending" },
                { "id": "6.1.2.2", "command": "DELETE backend/routers/sessions.py", "file": "backend/routers/sessions.py", "status": "pending" },
                { "id": "6.1.2.3", "command": "DELETE backend/routers/agents.py", "file": "backend/routers/agents.py", "status": "pending" },
                { "id": "6.1.2.4", "command": "UPDATE backend/routers/__init__.py to remove deleted router exports", "file": "backend/routers/__init__.py", "status": "pending" }
              ]
            }
          ]
        },
        {
          "id": "6.2",
          "title": "Verify System",
          "objective": "Ensure frontend works independently and backend starts cleanly with only health check",
          "status": "pending",
          "tasks": [
            {
              "id": "6.2.1",
              "title": "Verify backend starts cleanly",
              "file_path": "backend/main.py",
              "description": "Start backend server and verify it runs without errors. Only /health endpoint should respond.",
              "status": "pending",
              "context": {
                "read_before": [
                  { "file": "backend/main.py", "purpose": "Review final state of main.py" }
                ],
                "related_files": []
              },
              "depends_on": ["6.1.2"],
              "actions": [
                { "id": "6.2.1.1", "command": "RUN uvicorn backend.main:app to start backend", "file": "backend/main.py", "status": "pending" },
                { "id": "6.2.1.2", "command": "TEST curl localhost:8765/health returns healthy status", "file": "backend/main.py", "status": "pending" },
                { "id": "6.2.1.3", "command": "VERIFY curl localhost:8765/projects returns 404 (route removed)", "file": "backend/main.py", "status": "pending" }
              ]
            },
            {
              "id": "6.2.2",
              "title": "Verify full frontend functionality",
              "file_path": "frontend/src/",
              "description": "End-to-end verification that all frontend features work without backend routes.",
              "status": "pending",
              "context": {
                "read_before": [],
                "related_files": []
              },
              "depends_on": ["6.2.1"],
              "actions": [
                { "id": "6.2.2.1", "command": "TEST Project list loads via Drizzle", "file": "frontend/src/lib/projects-api.ts", "status": "pending" },
                { "id": "6.2.2.2", "command": "TEST Project CRUD operations work via local API routes", "file": "frontend/src/app/api/projects/", "status": "pending" },
                { "id": "6.2.2.3", "command": "TEST Session list and details load via Drizzle", "file": "frontend/src/lib/sessions-api.ts", "status": "pending" },
                { "id": "6.2.2.4", "command": "TEST Session artifacts load via local API routes", "file": "frontend/src/app/api/sessions/", "status": "pending" },
                { "id": "6.2.2.5", "command": "TEST Agent list and logs load via Drizzle", "file": "frontend/src/lib/agents-api.ts", "status": "pending" }
              ]
            }
          ]
        }
      ],
      "file_context": {
        "beginning": {
          "files": [
            { "path": "backend/main.py", "status": "exists", "description": "Includes all routers" },
            { "path": "backend/routers/projects.py", "status": "exists", "description": "To be removed" },
            { "path": "backend/routers/sessions.py", "status": "exists", "description": "To be removed" },
            { "path": "backend/routers/agents.py", "status": "exists", "description": "To be removed" }
          ]
        },
        "ending": {
          "files": [
            { "path": "backend/main.py", "status": "modified", "description": "Only health check remains" },
            { "path": "backend/routers/projects.py", "status": "deleted", "description": "Moved to frontend" },
            { "path": "backend/routers/sessions.py", "status": "deleted", "description": "Moved to frontend" },
            { "path": "backend/routers/agents.py", "status": "deleted", "description": "Moved to frontend" }
          ]
        }
      },
      "testing_strategy": {
        "approach": "Full system verification",
        "verification_steps": [
          "Backend starts with only /health endpoint",
          "Frontend fully functional without backend routes",
          "All CRUD and read operations work via frontend"
        ]
      }
    }
  ]
}
